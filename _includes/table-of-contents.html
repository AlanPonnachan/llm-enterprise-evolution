<!-- Toggle Button - Outside of TOC container -->
<button class="toc-toggle" id="toc-toggle" aria-label="Toggle Table of Contents">
    <span class="toc-toggle-icon">ðŸ“–</span>
    <span class="toc-toggle-text">Contents</span>
    <span class="toc-toggle-arrow">â—€</span>
</button>

<!-- TOC Sidebar -->
<div class="table-of-contents" id="toc-sidebar">
    <!-- Collapsible Content -->
    <div class="toc-content" id="toc-content">
        <div class="toc-header">
            <div class="toc-title">Contents</div>
            <button class="toc-close" id="toc-close" aria-label="Close Contents">Ã—</button>
        </div>
        
        <ul id="toc-list">
            <!-- TOC will be generated by JavaScript -->
        </ul>
        
        <!-- Progress indicator -->
        <div class="toc-progress">
            <div class="progress-label">Reading Progress</div>
            <div class="progress-bar">
                <div class="progress-fill" id="toc-progress-fill"></div>
            </div>
            <div class="progress-text" id="toc-progress-text">0%</div>
        </div>
        
        <!-- Reading time estimate -->
        <div class="toc-reading-time">
            <div class="time-label">ðŸ“š Est. Time Left</div>
            <div class="time-remaining" id="time-remaining">-- min</div>
        </div>
    </div>
</div>

<!-- Overlay for mobile -->
<div class="toc-overlay" id="toc-overlay"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const tocSidebar = document.getElementById('toc-sidebar');
    const tocToggle = document.getElementById('toc-toggle');
    const tocClose = document.getElementById('toc-close');
    const tocContent = document.getElementById('toc-content');
    const tocOverlay = document.getElementById('toc-overlay');
    const tocList = document.getElementById('toc-list');
    const progressFill = document.getElementById('toc-progress-fill');
    const progressText = document.getElementById('toc-progress-text');
    const timeRemaining = document.getElementById('time-remaining');
    
    const headings = document.querySelectorAll('.content-wrapper h2, .content-wrapper h3, .content-wrapper h4');
    
    // Check if TOC should be hidden when no headings
    if (headings.length === 0) {
        tocSidebar.style.display = 'none';
        return;
    }
    
    // State management
    let isCollapsed = localStorage.getItem('toc-collapsed') === 'true';
    let isMobile = window.innerWidth <= 1024;
    
    // Initialize state
    function initializeTOC() {
        // Update body class for layout adjustment
        if (isCollapsed) {
            document.body.classList.add('toc-collapsed');
            tocSidebar.classList.add('collapsed');
        } else {
            document.body.classList.remove('toc-collapsed');
            tocSidebar.classList.remove('collapsed');
        }
        
        if (isMobile) {
            tocSidebar.classList.add('mobile');
        } else {
            tocSidebar.classList.remove('mobile');
        }
        updateToggleButton();
    }
    
    // Update toggle button appearance
    function updateToggleButton() {
        const arrow = tocToggle.querySelector('.toc-toggle-arrow');
        const text = tocToggle.querySelector('.toc-toggle-text');
        
        if (isCollapsed) {
            arrow.textContent = 'â–¶';
            text.textContent = 'Show';
            tocToggle.setAttribute('aria-expanded', 'false');
        } else {
            arrow.textContent = 'â—€';
            text.textContent = 'Hide';
            tocToggle.setAttribute('aria-expanded', 'true');
        }
    }
    
    // Toggle TOC
    function toggleTOC() {
        isCollapsed = !isCollapsed;
        
        // Update classes for proper layout adjustment
        if (isCollapsed) {
            document.body.classList.add('toc-collapsed');
            tocSidebar.classList.add('collapsed');
        } else {
            document.body.classList.remove('toc-collapsed');
            tocSidebar.classList.remove('collapsed');
        }
        
        updateToggleButton();
        localStorage.setItem('toc-collapsed', isCollapsed);
        
        // Focus management for accessibility
        if (!isCollapsed && isMobile) {
            tocContent.focus();
        }
    }
    
    // Close TOC (mobile)
    function closeTOC() {
        if (isMobile) {
            isCollapsed = true;
            document.body.classList.add('toc-collapsed');
            tocSidebar.classList.add('collapsed');
            updateToggleButton();
            localStorage.setItem('toc-collapsed', isCollapsed);
        }
    }
    
    // Handle resize
    function handleResize() {
        const newIsMobile = window.innerWidth <= 1024;
        if (newIsMobile !== isMobile) {
            isMobile = newIsMobile;
            initializeTOC();
        }
    }
    
    // Event listeners
    tocToggle.addEventListener('click', toggleTOC);
    tocClose.addEventListener('click', closeTOC);
    tocOverlay.addEventListener('click', closeTOC);
    window.addEventListener('resize', handleResize);
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl/Cmd + Shift + T to toggle TOC
        if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'T') {
            e.preventDefault();
            toggleTOC();
        }
        // Escape to close TOC on mobile
        if (e.key === 'Escape' && !isCollapsed && isMobile) {
            closeTOC();
        }
    });
    
    // Generate TOC
    headings.forEach((heading, index) => {
        if (!heading.id) {
            heading.id = 'heading-' + index;
        }
        
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = '#' + heading.id;
        a.textContent = heading.textContent.replace(/^Chapter \d+:\s*/, '');
        a.className = 'toc-' + heading.tagName.toLowerCase();
        
        li.appendChild(a);
        tocList.appendChild(li);
    });
    
    // Calculate total reading time
    const totalWords = document.querySelector('.content-wrapper').textContent.split(/\s+/).length;
    const totalReadingTime = Math.ceil(totalWords / 200); // 200 words per minute
    
    // Update progress and time remaining
    function updateProgress() {
        const scrollTop = window.pageYOffset;
        const docHeight = document.documentElement.scrollHeight - window.innerHeight;
        const scrollPercent = Math.min(100, Math.max(0, (scrollTop / docHeight) * 100));
        
        // Update progress bar
        if (progressFill && progressText) {
            progressFill.style.width = scrollPercent + '%';
            progressText.textContent = Math.round(scrollPercent) + '%';
        }
        
        // Update time remaining
        if (timeRemaining) {
            const remainingPercent = (100 - scrollPercent) / 100;
            const remainingTime = Math.ceil(totalReadingTime * remainingPercent);
            timeRemaining.textContent = remainingTime + ' min';
        }
        
        // Highlight current section
        updateActiveSection();
    }
    
    // Update active section in TOC
    function updateActiveSection() {
        const tocLinks = document.querySelectorAll('#toc-list a');
        let current = '';
        
        headings.forEach(heading => {
            const rect = heading.getBoundingClientRect();
            if (rect.top <= 150) {
                current = heading.id;
            }
        });
        
        tocLinks.forEach(link => {
            link.classList.remove('active');
            if (link.getAttribute('href') === '#' + current) {
                link.classList.add('active');
            }
        });
    }
    
    // Smooth scrolling for TOC links
    document.querySelectorAll('#toc-list a').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
                
                // Close TOC on mobile after clicking
                if (isMobile) {
                    setTimeout(() => closeTOC(), 500);
                }
            }
        });
    });
    
    // Initialize everything
    initializeTOC();
    window.addEventListener('scroll', updateProgress);
    updateProgress();
});
</script>